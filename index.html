<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- FORCE FRESH CONTENT (Cache Busting) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Field Agent Claim</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #111827; 
            --accent: #2563eb; 
            --bg: #f3f4f6;
            --paper: #ffffff;
            --danger: #ef4444;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 16px;
            color: #1f2937;
            -webkit-user-select: none;
        }

        /* --- OVERLAYS (GPS & INTERNET) --- */
        .overlay-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 30px; box-sizing: border-box;
        }
        .icon-lg { font-size: 50px; margin-bottom: 20px; }
        .title-lg { font-size: 1.4rem; font-weight: 800; color: var(--primary); margin-bottom: 10px; }
        .desc-lg { color: #6b7280; margin-bottom: 30px; font-size: 0.95rem; }

        /* Hide overlays by default, JS will toggle them */
        #gps-screen { display: none; }
        #net-screen { display: none; } 

        /* --- MAIN APP --- */
        #main-app { display: none; }
        
        .card {
            background: var(--paper);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 20px;
        }

        h2 { margin: 0 0 20px; color: var(--primary); text-align: center; font-size: 1.2rem; }

        /* Form Inputs */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; font-weight: 700; color: #374151; margin-bottom: 6px; text-transform: uppercase; }
        input, select {
            width: 100%; padding: 14px; border: 1px solid #d1d5db; border-radius: 8px;
            font-size: 1rem; background: #fff; box-sizing: border-box;
        }
        
        /* Read Only Input Style */
        input:read-only { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; border-color: #e5e7eb; }
        
        /* Disabled Option Style */
        option:disabled { color: #d1d5db; }

        /* Validation Msg */
        .hint { font-size: 0.75rem; color: #dc2626; margin-top: 4px; display: none; }

        /* Buttons */
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 10px;
            font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 10px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-share { background: #059669; color: white; margin-bottom: 15px;}
        .btn-ghost { background: transparent; color: #6b7280; font-weight: normal; }

        /* --- RECEIPT DESIGN --- */
        #result-view { display: none; }
        
        /* This is the container that adds PADDING to the image */
        #capture-container {
            background: #ffffff;
            padding: 40px; /* This creates the white border in the image */
            width: 100%;
            box-sizing: border-box;
        }

        #receipt-box {
            border: 2px solid #000;
            font-family: 'Courier New', Courier, monospace;
            color: #000;
            position: relative;
        }
        
        .r-header { background: #000; color: #fff; padding: 15px; display: flex; justify-content: space-between; }
        .r-body { padding: 20px; }
        .r-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; }
        .r-total { border-top: 2px dashed #000; padding-top: 15px; margin-top: 15px; font-weight: 900; font-size: 1.4rem; display: flex; justify-content: space-between; }
        
        .watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 3rem; opacity: 0.1; font-weight: 900; pointer-events: none; border: 5px solid #000; padding: 10px;
        }
    </style>
</head>
<body>

<!-- 1. CUSTOM INTERNET WARNING -->
<div id="net-screen" class="overlay-screen" style="z-index: 10000;">
    <div class="icon-lg">ðŸ“¶</div>
    <div class="title-lg">No Internet Connection</div>
    <div class="desc-lg">This app requires an active network connection to verify latest rates and submit claims.</div>
    <button class="btn btn-primary" onclick="checkNet()">Retry Connection</button>
</div>

<!-- 2. GPS LOCK SCREEN -->
<div id="gps-screen" class="overlay-screen">
    <div class="icon-lg">ðŸ“¡</div>
    <div class="title-lg">Location Required</div>
    <div class="desc-lg">We need your GPS location to verify this site visit.</div>
    <button class="btn btn-primary" onclick="initGPS()">Enable GPS</button>
    <div id="gps-err" style="color:red; font-size:0.8rem; margin-top:10px;"></div>
</div>

<!-- 3. MAIN APP -->
<div id="main-app">
    
    <!-- INPUT FORM -->
    <div class="card" id="input-view">
        <div style="text-align:center; color:#059669; font-weight:bold; font-size:0.8rem; margin-bottom:15px;">
            âœ… SYSTEM LIVE â€¢ UPDATED
        </div>

        <div class="form-group">
            <label>Purpose / Agent Name</label>
            <input type="text" id="purpose" placeholder="e.g. Doc Collection">
        </div>

        <div class="form-group">
            <label>Total Return Distance (KM)</label>
            <input type="number" id="dist" placeholder="0" oninput="validateVehicleOption()">
        </div>

        <div class="form-group">
            <label>Vehicle Type</label>
            <select id="vehicle">
                <option value="bike">Bike (Two Wheeler)</option>
                <option value="car" disabled>Car (Four Wheeler)</option>
            </select>
            <!-- Warning if car is disabled -->
            <div id="car-hint" class="hint">âš ï¸ Car allowed only for distance > <span id="min-km-txt"></span> KM</div>
        </div>

        <div class="form-group">
            <label>Petrol Price (Today)</label>
            <!-- READ ONLY: Controlled by Config -->
            <input type="number" id="price" readonly>
        </div>

        <button class="btn btn-primary" onclick="calculate()">Calculate</button>
    </div>

    <!-- RESULT / RECEIPT -->
    <div id="result-view">
        <div style="overflow:hidden; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.1); margin-bottom:20px;">
            
            <!-- CAPTURE CONTAINER (Adds Padding) -->
            <div id="capture-container">
                <div id="receipt-box">
                    <div class="watermark">GPS LOCKED</div>
                    
                    <div class="r-header">
                        <div><strong>EXPENSE CLAIM</strong><br><small id="r-id">ID: --</small></div>
                        <div style="text-align:right"><small id="r-date">DATE</small></div>
                    </div>

                    <div class="r-body">
                        <div class="r-row"><span>Agent:</span><strong id="r-agent">--</strong></div>
                        <div class="r-row"><span>Vehicle:</span><span id="r-veh">--</span></div>
                        <div class="r-row"><span>GPS:</span><span id="r-gps" style="font-size:0.7rem">--</span></div>
                        <hr style="border-top:1px dashed #ccc; margin:15px 0;">
                        
                        <div class="r-row"><span>Distance Input:</span><span id="r-d-in">0</span></div>
                        <div class="r-row"><span>Buffer Added:</span><span id="r-buff">0</span></div>
                        <div class="r-row"><span><strong>Billable Dist:</strong></span><strong id="r-d-bill">0</strong></div>
                        
                        <div style="margin-top:15px"></div>
                        <div class="r-row"><span>Fuel Cost:</span><span id="r-c-fuel">0</span></div>
                        <div style="text-align:right; font-size:0.7rem; color:#666; margin-top:-8px;" id="r-txt-fuel">rate info</div>

                        <div class="r-row" style="margin-top:10px"><span>Maintenance:</span><span id="r-c-wear">0</span></div>
                        <div style="text-align:right; font-size:0.7rem; color:#666; margin-top:-8px;" id="r-txt-wear">rate info</div>

                        <div class="r-total">
                            <span>TOTAL:</span>
                            <span id="r-total">â‚¹0.00</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END CAPTURE -->

        </div>

        <button class="btn btn-share" onclick="shareImage()">ðŸ“² Share Official Receipt</button>
        <button class="btn btn-ghost" onclick="location.reload()">Start New Claim</button>
    </div>

</div>

<script>
    // ==========================================================
    // âš™ï¸ BACKEND CONFIGURATION (EDIT THIS TO UPDATE APP)
    // ==========================================================
    const CONFIG = {
        fuelPrice: 104.50,       // Fixed Fuel Price (User cannot edit)
        wearBike: 1.50,          // Maintenance per KM for Bike
        wearCar: 4.00,           // Maintenance per KM for Car
        
        minKmForCar: 30,         // Car option disabled if KM is less than this
        
        bufferBike: 10,          // Extra KM added for Bike
        bufferCar: 20            // Extra KM added for Car
    };
    // ==========================================================

    let gpsCoords = null;

    // 1. INITIALIZATION & CHECKS
    window.onload = function() {
        // Set UI values from Config
        document.getElementById('price').value = CONFIG.fuelPrice.toFixed(2);
        document.getElementById('min-km-txt').innerText = CONFIG.minKmForCar;
        
        checkNet(); // Check Internet
    };

    // 2. INTERNET CHECKER
    function checkNet() {
        if(navigator.onLine) {
            document.getElementById('net-screen').style.display = 'none';
            initGPS(); // Proceed to GPS check
        } else {
            document.getElementById('net-screen').style.display = 'flex';
        }
    }
    // Listen for connection changes
    window.addEventListener('offline', () => document.getElementById('net-screen').style.display = 'flex');
    window.addEventListener('online', () => document.getElementById('net-screen').style.display = 'none');

    // 3. GPS CHECKER
    function initGPS() {
        document.getElementById('gps-screen').style.display = 'flex';
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    gpsCoords = pos.coords.latitude.toFixed(5) + ", " + pos.coords.longitude.toFixed(5);
                    document.getElementById('gps-screen').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                },
                (err) => {
                    document.getElementById('gps-err').innerText = "Permission Denied or Error. Please enable GPS.";
                },
                { enableHighAccuracy: true }
            );
        } else {
            document.getElementById('gps-err').innerText = "GPS not supported.";
        }
    }

    // 4. DYNAMIC CAR LOGIC
    function validateVehicleOption() {
        const dist = parseFloat(document.getElementById('dist').value) || 0;
        const carOpt = document.querySelector('option[value="car"]');
        const bikeOpt = document.querySelector('option[value="bike"]');
        const select = document.getElementById('vehicle');
        const hint = document.getElementById('car-hint');

        if (dist < CONFIG.minKmForCar) {
            // Disable Car
            carOpt.disabled = true;
            if(select.value === 'car') select.value = 'bike'; // Force bike
            hint.style.display = 'block';
        } else {
            // Enable Car
            carOpt.disabled = false;
            hint.style.display = 'none';
        }
    }

    // 5. CALCULATION
    function calculate() {
        const distIn = parseFloat(document.getElementById('dist').value);
        if(!distIn || distIn <= 0) { alert("Enter valid distance"); return; }
        
        const type = document.getElementById('vehicle').value;
        const purpose = document.getElementById('purpose').value || "Field Visit";
        
        // --- LOGIC FROM CONFIG ---
        const mileage = (type === 'bike') ? 45 : 17;
        const wearRate = (type === 'bike') ? CONFIG.wearBike : CONFIG.wearCar;
        const buffer = (type === 'bike') ? CONFIG.bufferBike : CONFIG.bufferCar;
        const price = CONFIG.fuelPrice;

        const totalDist = distIn + buffer;
        const costFuel = (totalDist / mileage) * price;
        const costWear = totalDist * wearRate;
        const total = Math.round(costFuel + costWear);

        // --- FILL RECEIPT ---
        document.getElementById('r-id').innerText = "ID: " + Date.now().toString().slice(-6);
        document.getElementById('r-date').innerText = new Date().toLocaleString();
        document.getElementById('r-agent').innerText = purpose;
        document.getElementById('r-veh').innerText = (type==='bike') ? "Bike" : "Car";
        document.getElementById('r-gps').innerText = gpsCoords;

        document.getElementById('r-d-in').innerText = distIn + " km";
        document.getElementById('r-buff').innerText = "+ " + buffer + " km";
        document.getElementById('r-d-bill').innerText = totalDist.toFixed(1) + " km";

        document.getElementById('r-c-fuel').innerText = "â‚¹" + costFuel.toFixed(2);
        document.getElementById('r-txt-fuel').innerText = `@ â‚¹${price}/L Ã· ${mileage} km/l`;

        document.getElementById('r-c-wear').innerText = "â‚¹" + costWear.toFixed(2);
        document.getElementById('r-txt-wear').innerText = `@ â‚¹${wearRate.toFixed(2)} / km`;

        document.getElementById('r-total').innerText = "â‚¹" + total.toFixed(2);

        // SHOW RESULT
        document.getElementById('input-view').style.display = 'none';
        document.getElementById('result-view').style.display = 'block';
        window.scrollTo(0,0);
    }

    // 6. SHARE IMAGE
    function shareImage() {
        const btn = document.querySelector('.btn-share');
        btn.innerText = "Processing...";
        
        // Capture the CONTAINER (including the padding)
        html2canvas(document.getElementById('capture-container'), {
            scale: 2,
            backgroundColor: "#ffffff" // Ensure white background for padding
        }).then(canvas => {
            const base64 = canvas.toDataURL("image/png");
            if(window.AndroidShareHandler) {
                window.AndroidShareHandler.shareImage(base64);
                btn.innerText = "ðŸ“² Share Official Receipt";
            } else {
                console.log("Not Android. Open console to see Base64.");
                alert("This feature works in the App.");
                btn.innerText = "ðŸ“² Share Official Receipt";
            }
        });
    }
</script>
</body>
</html>
